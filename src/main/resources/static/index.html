<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–π –¥–æ—Å—É–≥ - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .chat-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .chat-messages {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .user-message {
            background-color: #e9f5ff;
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 80%;
            margin-left: auto;
            text-align: right;
        }
        .bot-message {
            background-color: #f5f5f5;
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 80%;
        }
        .message-input {
            display: flex;
        }
        .message-input input {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .message-input button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        .spinner-border {
            display: none;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <h1>–°–µ–º–µ–π–Ω—ã–π –¥–æ—Å—É–≥</h1>
                <p class="text-muted">–ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–º–µ–π–Ω–æ–≥–æ –≤—Ä–µ–º—è–ø—Ä–µ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="bot-message">
                    –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –Ω–∞–π—Ç–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –¥–æ—Å—É–≥–∞. 
                    –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –¥–ª—è –∫–æ–≥–æ –≤—ã –∏—â–µ—Ç–µ –∑–∞–Ω—è—Ç–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¥–æ—á–∫–∞ 6 –ª–µ—Ç"), 
                    –∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ (–¥–∞—Ç–∞ –∏–ª–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏) –∏ –∫–∞–∫–∏–µ —É –≤–∞—Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è.
                </div>
            </div>
            
            <div class="message-input">
                <div class="spinner-border text-primary" role="status" id="loadingSpinner">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <input type="text" class="form-control" id="messageInput" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn btn-primary" id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            <div class="mt-3">
                <p class="text-muted">–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-secondary example-query">–ß—Ç–æ –ø–æ–¥–µ–ª–∞—Ç—å —Å –¥–æ—á–∫–æ–π 6 –ª–µ—Ç –≤ —ç—Ç–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ?</button>
                    <button class="btn btn-sm btn-outline-secondary example-query">–ö—É–¥–∞ —Å—Ö–æ–¥–∏—Ç—å —Å —Å—ã–Ω–æ–º 10 –ª–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–≤–ª–µ–∫–∞–µ—Ç—Å—è –Ω–∞—É–∫–æ–π?</button>
                    <button class="btn btn-sm btn-outline-secondary example-query">–ü–æ–¥—Å–∫–∞–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –¥–æ—Å—É–≥–∞ —Å –¥–µ—Ç—å–º–∏ 5 –∏ 8 –ª–µ—Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const exampleButtons = document.querySelectorAll('.example-query');
            
            // Add click event listeners to example query buttons
            exampleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    messageInput.value = button.textContent;
                    messageInput.focus();
                });
            });
            
            // Function to add a message to the chat
            function addMessage(message, isUser) {
                const messageElement = document.createElement('div');
                messageElement.className = isUser ? 'user-message' : 'bot-message';
                
                // Convert markdown-like syntax to HTML
                let formattedMessage = message;
                // Bold text
                formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Italic text
                formattedMessage = formattedMessage.replace(/_(.*?)_/g, '<em>$1</em>');
                // Links
                formattedMessage = formattedMessage.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                // New lines
                formattedMessage = formattedMessage.replace(/\n/g, '<br>');
                
                messageElement.innerHTML = formattedMessage;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to send a message
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message === '') return;
                
                // Add user message to chat
                addMessage(message, true);
                messageInput.value = '';
                
                // Show loading spinner
                loadingSpinner.style.display = 'inline-block';
                sendButton.disabled = true;
                
                // Send message to server
                fetch('/family-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                })
                .then(response => response.json())
                .then(data => {
                    // Format the response for display
                    let botResponse = formatActivityResponse(data);
                    
                    // Add bot response to chat
                    addMessage(botResponse, false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', false);
                })
                .finally(() => {
                    // Hide loading spinner
                    loadingSpinner.style.display = 'none';
                    sendButton.disabled = false;
                    messageInput.focus();
                });
            }
            
            // Format the JSON response into a readable message
            function formatActivityResponse(response) {
                let formattedResponse = '';
                
                // Add introduction
                const familyMember = response.request.familyMember;
                if (familyMember) {
                    formattedResponse += `–í–æ—Ç —á—Ç–æ —è –Ω–∞—à–µ–ª –¥–ª—è ${familyMember.role || '–≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞'}`;
                    if (familyMember.age) {
                        formattedResponse += ` ${familyMember.age} –ª–µ—Ç`;
                    }
                    formattedResponse += ':\n\n';
                } else {
                    formattedResponse += '–í–æ—Ç —á—Ç–æ —è –Ω–∞—à–µ–ª:\n\n';
                }
                
                // Add selected time slot if available
                if (response.selectedTimeSlot) {
                    formattedResponse += `üóìÔ∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: ${response.selectedTimeSlot.selectedDate} –≤ ${response.selectedTimeSlot.selectedTimeRange}\n\n`;
                }
                
                // Add activities
                if (response.activities && response.activities.length > 0) {
                    response.activities.forEach((activity, index) => {
                        formattedResponse += `${index + 1}. **${activity.title}**\n`;
                        
                        if (activity.description) {
                            formattedResponse += `   ${activity.description}\n`;
                        }
                        
                        // Add details
                        const details = [];
                        if (activity.date) details.push(`–î–∞—Ç–∞: ${activity.date}`);
                        if (activity.time) details.push(`–í—Ä–µ–º—è: ${activity.time}`);
                        if (activity.location) details.push(`–ì–¥–µ: ${activity.location}`);
                        if (activity.price) details.push(`–¶–µ–Ω–∞: ${activity.price}`);
                        if (activity.ageRestriction) details.push(`–í–æ–∑—Ä–∞—Å—Ç: ${activity.ageRestriction}`);
                        
                        if (details.length > 0) {
                            formattedResponse += `   _${details.join(' | ')}_\n`;
                        }
                        
                        if (activity.url) {
                            formattedResponse += `   üîó [–ü–æ–¥—Ä–æ–±–Ω–µ–µ](${activity.url})\n`;
                        }
                        
                        formattedResponse += '\n';
                    });
                } else {
                    formattedResponse += '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è.';
                }
                
                return formattedResponse;
            }
            
            // Handle send button click
            sendButton.addEventListener('click', sendMessage);
            
            // Handle enter key press in input field
            messageInput.addEventListener('keypress', event => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Focus input field on page load
            messageInput.focus();
        });
    </script>
</body>
</html> 