<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AI Tutor Family Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .chat-container { max-width: 540px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.10); padding: 28px 18px 18px 18px; }
        .messages { min-height: 220px; margin-bottom: 18px; }
        .message { margin-bottom: 18px; }
        .user-msg { color: #1976d2; font-weight: bold; margin-bottom: 6px; }
        .bot-msg { color: #388e3c; font-weight: bold; margin-bottom: 6px; }
        .input-row { display: flex; gap: 8px; }
        input[type=text] { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        button { padding: 10px 18px; border: none; border-radius: 5px; background: #1976d2; color: #fff; cursor: pointer; font-size: 1em; }
        button:disabled { background: #aaa; }
        .event-card { display: flex; gap: 18px; align-items: flex-start; background: #f5faff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin: 18px 0; padding: 18px; border: 1px solid #e0e0e0; }
        .event-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; background: #eee; flex-shrink: 0; }
        .event-info { flex: 1; }
        .event-title { font-size: 1.18em; font-weight: bold; color: #1976d2; margin-bottom: 8px; }
        .event-datetime { color: #888; font-size: 1em; margin-bottom: 8px; }
        .event-desc { color: #222; font-size: 1.04em; white-space: pre-line; }
    </style>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script>
const { useState, useRef, useEffect } = React;

function EventCard({ event }) {
    return (
        <div className="event-card">
            {event.imageUrl && <img className="event-img" src={event.imageUrl} alt={event.title} />}
            <div className="event-info">
                <div className="event-title">{event.title}</div>
                {(event.date || event.time) && (
                    <div className="event-datetime">
                        {event.date ? `Дата: ${event.date}` : ''}{event.date && event.time ? ', ' : ''}{event.time ? `Время: ${event.time}` : ''}
                    </div>
                )}
                <div className="event-desc">{event.description && event.description.trim()}</div>
            </div>
        </div>
    );
}

function Message({ msg }) {
    if (msg.sender === 'user') {
        return <div className="message"><div className="user-msg">Вы: {msg.text}</div></div>;
    }
    // bot
    let parsed;
    try { parsed = JSON.parse(msg.text); } catch {}
    if (Array.isArray(parsed)) {
        return (
            <div className="message">
                <div className="bot-msg">Бот:</div>
                {parsed.map((event, i) => <EventCard event={event} key={i} />)}
            </div>
        );
    }
    return <div className="message"><div className="bot-msg">Бот: {msg.text}</div></div>;
}

function Chat() {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    const sendMessage = async (e) => {
        e.preventDefault();
        if (!input.trim()) return;
        setMessages(msgs => [...msgs, { sender: 'user', text: input }]);
        setInput('');
        setLoading(true);
        setMessages(msgs => [...msgs, { sender: 'bot', text: '...' }]);
        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: input })
            });
            const data = await res.json();
            setMessages(msgs => [...msgs.slice(0, -1), { sender: 'bot', text: typeof data === 'string' ? data : JSON.stringify(data) }]);
        } catch {
            setMessages(msgs => [...msgs.slice(0, -1), { sender: 'bot', text: 'Ошибка при получении ответа' }]);
        }
        setLoading(false);
    };

    return (
        <div className="chat-container">
            <div className="messages">
                {messages.map((msg, i) => <Message msg={msg} key={i} />)}
                <div ref={messagesEndRef} />
            </div>
            <form className="input-row" onSubmit={sendMessage}>
                <input
                    type="text"
                    value={input}
                    onChange={e => setInput(e.target.value)}
                    placeholder="Введите запрос..."
                    disabled={loading}
                    autoFocus
                />
                <button type="submit" disabled={loading || !input.trim()}>Отправить</button>
            </form>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Chat />);
</script>
</body>
</html> 