# Система рекомендаций для семейного досуга

Данная система позволяет обрабатывать запросы на естественном языке и предлагать рекомендации для семейного досуга на основе предпочтений, возрастных ограничений и доступного времени.

## Архитектура

Система состоит из следующих компонентов:

1. **ConversationFlowService** - извлекает структурированную информацию из запроса пользователя
2. **DateSelectionService** - выбирает оптимальное время для мероприятия на основе доступных временных слотов
3. **SearchQueryService** - формирует поисковый запрос для поиска мероприятий
4. **ParserService** - ищет и обрабатывает данные о мероприятиях
5. **KudaGoApiService** - взаимодействует с API KudaGo для получения актуальных данных о мероприятиях
6. **FamilyActivityController** - обрабатывает HTTP-запросы и координирует работу сервисов

## Интеграция с KudaGo API

Система интегрирована с [API KudaGo](https://docs.kudago.com/api/) для получения актуальной информации о мероприятиях в различных городах России. Реализованы следующие возможности:

- Получение списка доступных городов через эндпоинт `/locations`
- Получение категорий мероприятий через эндпоинт `/categories`
- Поиск мероприятий по различным параметрам через эндпоинт `/events`
- Получение детальной информации о конкретном мероприятии через эндпоинт `/events/{id}`

Все ответы API кэшируются для снижения нагрузки на сервер KudaGo. Кэш обновляется автоматически раз в день.

## Использование

### Подготовка окружения

1. Убедитесь, что у вас установлен JDK 17 или выше
2. Запустите Ollama с подходящей моделью (например, `ollama run llama3`)
3. Настройте конфигурацию Spring AI в `application.yml` для указания URL Ollama и модели

### Запуск приложения

```bash
./gradlew bootRun
```

### API-запросы

#### Запрос рекомендаций для семейного досуга

```http
POST http://localhost:8080/family-activity
Content-Type: application/json

{
  "message": "Что поделать с дочкой 6 лет в эти выходные? Нам нравится активный отдых и творчество."
}
```

#### Запрос с автоматическим подбором времени

```http
POST http://localhost:8080/family-activity
Content-Type: application/json

{
  "message": "Подскажи, какие мероприятия можно посетить с сыном 10 лет? Он увлекается наукой и техникой. Ты можешь сам подобрать удобное время."
}
```

#### Запрос с указанием города

```http
POST http://localhost:8080/family-activity
Content-Type: application/json

{
  "message": "Какие интересные выставки сейчас проходят в Санкт-Петербурге?"
}
```

#### Получение списка доступных городов

```http
GET http://localhost:8080/api/kudago/locations
```

#### Получение категорий мероприятий

```http
GET http://localhost:8080/api/kudago/categories
```

#### Поиск мероприятий через KudaGo API

```http
GET http://localhost:8080/api/kudago/events?location=msk&categories=exhibition,theater&ageRestriction=6%2B
```

#### Формат ответа

```json
{
  "request": {
    "familyMember": {
      "role": "дочка",
      "age": 6
    },
    "date": null,
    "dayOfWeek": "выходные",
    "preferences": ["активный отдых", "творчество"],
    "restrictions": [],
    "needsTimeSlotSelection": false
  },
  "selectedTimeSlot": null,
  "activities": [
    {
      "title": "Мастер-класс по рисованию для детей",
      "description": "Увлекательный мастер-класс по рисованию для детей от 5 до 10 лет.",
      "imageUrl": "https://example.com/images/drawing-class.jpg",
      "date": "2023-10-01",
      "time": "12:00-14:00",
      "location": "Детский центр 'Радуга', ул. Пушкина, 10",
      "price": "1000 руб",
      "ageRestriction": "5-10 лет",
      "category": "Мастер-класс",
      "url": "https://example.com/events/drawing-class"
    }
  ]
}
```

## Настройка

### Конфигурация Ollama

Настройте параметры Ollama в файле `application.yml`:

```yaml
spring:
  ai:
    ollama:
      base-url: http://localhost:11434
      model: llama3
```

### Добавление доступных временных слотов

Для добавления доступных временных слотов можно использовать `DateSelectionService`:

```kotlin
@Autowired
private lateinit var dateSelectionService: DateSelectionService

// Где-то в коде инициализации
dateSelectionService.addAvailableTimeSlots(
    "дочь", 
    listOf(
        "2023-10-01 10:00-13:00",
        "2023-10-01 15:00-18:00"
    )
)
```

## Расширение функциональности

### Добавление новых источников данных

В настоящее время система использует API KudaGo для получения данных о мероприятиях. Вы можете расширить функциональность, добавив поддержку других API или источников данных:

- Другие агрегаторы событий и афиш
- API билетных сервисов
- Парсинг сайтов с мероприятиями

### Улучшение RAG

Для улучшения автоматического подбора дат и рекомендаций, расширьте базу знаний RAG добавлением документов о:

- Популярных активностях для разных возрастных групп
- Сезонных мероприятиях
- Образовательных активностях для детей

## Тестирование

Запустите тесты с помощью Gradle:

```bash
./gradlew test
```

Для ручного тестирования можно использовать файл `sample-requests.http`.

## Ограничения текущей реализации

1. Ограниченная поддержка географического контекста
2. Нет учета погоды при рекомендациях для активностей на открытом воздухе
3. Лимиты API KudaGo на количество запросов в единицу времени 